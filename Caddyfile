# Caddy configuration for PlayFunia applications
# Caddy automatically handles SSL certificates via Let's Encrypt

# Main Playfunia website - playfunia.com with HTTPS
playfunia.com {
    # API routes go to backend
    handle /api/* {
        reverse_proxy 172.20.0.1:5001
    }

    # Chatbot API
    handle /chatbot/* {
        uri strip_prefix /chatbot
        reverse_proxy 172.20.0.1:8002
    }

    # All other requests go to frontend
    handle {
        reverse_proxy 172.20.0.1:3002
    }

    # Enable compression
    encode gzip zstd

    # Access logging
    log {
        output stdout
        format console
        level INFO
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# www redirect to non-www
www.playfunia.com {
    redir https://playfunia.com{uri} permanent
}

# Employee Management Portal - admin.playfunia.com with HTTPS
admin.playfunia.com {
    # Reverse proxy to Next.js employee management app
    reverse_proxy app:3000

    # Enable compression
    encode gzip zstd

    # Access logging
    log {
        output stdout
        format console
        level INFO
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }
}

# Redirect HTTP IP access to admin.playfunia.com
http://72.62.162.219:80 {
    redir https://admin.playfunia.com{uri} permanent
}
